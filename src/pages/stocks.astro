---
import Layout from '../layouts/Layout.astro';
import { h } from 'preact';
import { useState, useEffect } from 'preact/hooks';
import Chart from 'chart.js/auto';
import 'chartjs-adapter-date-fns';
---

<Layout>
  <section class="py-20 relative">
    <div class="container mx-auto text-center">
      <h2 class="text-4xl font-bold mb-10">Stock Market Data</h2>
      <input 
        type="text" 
        id="stockInput"
        class="mb-4 p-2 border border-gray-300 rounded"
        placeholder="Enter stock handle or title" 
      />
      <button 
        id="fetchButton"
        class="bg-blue-600 text-white px-4 py-2 rounded"
      >
        Fetch Data
      </button>

      <div id="timeRangeButtons" class="mt-8 hidden">
        <button class="px-4 py-2" data-range="1D">1D</button>
        <button class="px-4 py-2" data-range="1W">1W</button>
        <button class="px-4 py-2" data-range="1M">1M</button>
        <button class="px-4 py-2" data-range="1Y">1Y</button>
        <button class="px-4 py-2" data-range="ALL">ALL</button>
      </div>

      <div id="chartContainer" class="mt-8">
        <canvas id="stockChart"></canvas>
      </div>
    </div>

    <div id="errorPopup" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center hidden">
      <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative max-w-md mx-auto">
        <strong class="font-bold">Error</strong>
        <span class="block sm:inline">Unfortunately, my API has been ratelimited. Please come back in 1-2 minutes to try again.</span>
      </div>
    </div>
  </section>

  <script type="module">
    import Chart from '../node_modules/chart.js/auto';
    import '../node_modules/chartjs-adapter-date-fns';

    const fetchButton = document.getElementById('fetchButton');
    const stockInput = document.getElementById('stockInput');
    const chartContainer = document.getElementById('chartContainer');
    const timeRangeButtons = document.getElementById('timeRangeButtons').querySelectorAll('button');
    const timeRangeButtonsContainer = document.getElementById('timeRangeButtons');
    let chartInstance = null;
    let currentStock = '';
    let timeRange = '1M'; // Default time range to 1 Month

    fetchButton.addEventListener('click', fetchStockData);

    timeRangeButtons.forEach(button => {
      button.addEventListener('click', () => handleTimeRangeChange(button.dataset.range));
    });

    async function fetchStockData() {
      currentStock = stockInput.value.trim();
      if (!currentStock) {
        console.log('No stock input');
        return;
      }

      try {
        const response = await fetch(`/api/fetch.json?stock=${encodeURIComponent(currentStock)}&range=${timeRange}`);
        const data = await response.json();

        if (response.status >= 500 || (data.error && data.error.includes("You've exceeded the maximum requests per minute"))) {
          showPopup();
        } else if (!data.error) {
          renderChart(data);
          timeRangeButtonsContainer.classList.remove('hidden');
        } else {
          console.error(data.error);
        }
      } catch (error) {
        console.error('Error fetching data:', error);
        showPopup();
      }
    }

    function handleTimeRangeChange(range) {
      timeRange = range;
      fetchStockData();
    }

    function renderChart(data) {
      const ctx = document.getElementById('stockChart').getContext('2d');

      if (chartInstance) {
        chartInstance.destroy();
      }

      chartInstance = new Chart(ctx, {
        type: 'line',
        data: {
          labels: data.dates,
          datasets: [{
            label: `Stock Prices for ${data.stock}`,
            data: data.prices,
            borderColor: 'rgba(75, 192, 192, 1)',
            backgroundColor: 'rgba(75, 192, 192, 0.2)',
            fill: true,
            tension: 0.4
          }]
        },
        options: {
          responsive: true,
          scales: {
            x: {
              type: 'time',
              time: {
                unit: timeRange === '1D' ? 'hour' : 
                       timeRange === '1W' ? 'day' : 
                       timeRange === '1M' ? 'week' : 
                       timeRange === '1Y' ? 'month' : 'year'
              },
              title: {
                display: true,
                text: 'Date'
              }
            },
            y: {
              title: {
                display: true,
                text: 'Price'
              }
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              mode: 'index',
              intersect: false
            },
            hover: {
              mode: 'nearest',
              intersect: true
            }
          }
        }
      });
    }

    function showPopup() {
      const popup = document.getElementById('errorPopup');
      popup.classList.remove('hidden');
    }

    // Fetch data when the page loads with the default time range
    document.addEventListener('DOMContentLoaded', fetchStockData);
  </script>
</Layout>
